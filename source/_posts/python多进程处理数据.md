---
title: pythonå¤šè¿›ç¨‹å¤„ç†æ•°æ®
date: 2023-04-25 08:07:46
tags: [python, multiprocess]
---

# å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹

è¿›ç¨‹(multiprocess)æ˜¯æ“ä½œç³»ç»Ÿèµ„æºåˆ†é…ï¼ˆå†…å­˜ï¼Œæ˜¾å¡ï¼Œç£ç›˜ï¼‰çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹(Thread)æ˜¯æ‰§è¡Œè°ƒåº¦ï¼ˆå³cpuè°ƒåº¦ï¼‰çš„æœ€å°å•ä½ï¼ˆcpuçœ‹åˆ°çš„éƒ½æ˜¯çº¿ç¨‹è€Œä¸æ˜¯è¿›ç¨‹ï¼‰ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹çš„èµ„æºã€‚

cpuç‰©ç†æ ¸æ•°å®é™…ä¸Šæ˜¯å¯ä»¥åŒæ—¶å¹¶è¡Œçš„çº¿ç¨‹æ•°é‡ï¼Œç”±äºè¶…çº¿ç¨‹æŠ€æœ¯ï¼Œéƒ¨åˆ†cpuå®é™…ä¸Šå¯ä»¥å¹¶è¡Œçš„çº¿ç¨‹æ•°é‡é€šå¸¸æ˜¯ç‰©ç†æ ¸æ•°çš„ä¸¤å€ï¼Œè¿™ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçœ‹åˆ°çš„æ ¸æ•°ã€‚

å¤„ç†ä»»åŠ¡å¯ä»¥åˆ†ä¸ºè®¡ç®—å¯†é›†å‹å’ŒIOå¯†é›†å‹ï¼Œå‡è®¾ä½¿ç”¨ä¸€ä¸ªè¿›ç¨‹æ¥å®Œæˆè¿™ä¸ªä»»åŠ¡ï¼Œå¯¹è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ã€<strong style="color:#00b050;">æ ¸å¿ƒæ•°</strong>ã€‘ä¸ªçº¿ç¨‹ï¼Œå°±å¯ä»¥å æ»¡cpuèµ„æºï¼Œè¿›è€Œå¯ä»¥å……åˆ†åˆ©ç”¨cpuï¼Œå¦‚æœå†å¤šï¼Œå°±ä¼šé€ æˆé¢å¤–çš„å¼€é”€ï¼›å¯¹äºIOå¯†é›†å‹ä»»åŠ¡ï¼ˆæ¶‰åŠåˆ°ç½‘ç»œã€ç£ç›˜IOçš„ä»»åŠ¡éƒ½æ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼‰ï¼Œçº¿ç¨‹ç”±äºè¢«IOé˜»å¡ï¼Œå¦‚æœä»ç„¶ç”¨ã€æ ¸å¿ƒæ•°ã€‘ä¸ªçº¿ç¨‹ï¼Œcpuæ˜¯è·‘ä¸æ»¡çš„ï¼Œäºæ˜¯å¯ä»¥ä½¿ç”¨<strong style="color:#00b050;">æ›´å¤šä¸ªçº¿ç¨‹</strong>æ¥æé«˜cpuä½¿ç”¨ç‡ã€‚



# pythonä¸­çš„å¹¶è¡Œ

å¯¹äºå…¶ä»–è¯­è¨€ï¼Œå¤šæ ¸CPUæ”¯æŒå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œã€‚ä½†åœ¨Pythonä¸­ï¼Œæ— è®ºæ˜¯å•æ ¸è¿˜æ˜¯å¤šæ ¸cpuï¼Œä¸€ä¸ªè¿›ç¨‹åŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œã€‚å…¶æ ¹æºæ˜¯ <strong style="color:#00b050;">GILï¼ˆGlobal Interpreter Lock å…¨å±€è§£é‡Šå™¨é”)</strong> çš„å­˜åœ¨ã€‚

è®¾è®¡åŸå› ï¼šå¤šçº¿ç¨‹ä¼šå…±äº«è¿›ç¨‹ä¸­çš„åœ°å€ç©ºé—´å’Œæ•°æ®ç©ºé—´ï¼Œä¸€ä¸ªçº¿ç¨‹çš„æ•°æ®å¯ä»¥ç›´æ¥æä¾›ç»™å…¶ä»–çº¿ç¨‹ä½¿ç”¨ï¼Œç‰¹åˆ«å®¹æ˜“é€ æˆå˜é‡å€¼çš„æ··ä¹±ï¼Œæ‰€ä»¥é€šè¿‡çº¿ç¨‹é”æ¥é™åˆ¶çº¿ç¨‹çš„æ‰§è¡Œï¼Œä¿æŠ¤æ•°æ®å®‰å…¨ã€‚æŸä¸ªçº¿ç¨‹æƒ³è¦æ‰§è¡Œï¼Œå¿…é¡»å…ˆæ‹¿åˆ° GILï¼Œåœ¨ä¸€ä¸ª Python è¿›ç¨‹ä¸­ï¼ŒGIL åªæœ‰ä¸€ä¸ªã€‚æ‹¿ä¸åˆ°é€šè¡Œè¯çš„çº¿ç¨‹ï¼Œå°±ä¸å…è®¸è¿›å…¥ CPU æ‰§è¡Œã€‚æ‰€ä»¥å¤šçº¿ç¨‹åœ¨pythonä¸­æ˜¯è¡Œä¸é€šçš„ã€‚pythonä¸­çš„å¹¶è¡Œä¸»è¦æŒ‡çš„æ˜¯è¿›ç¨‹å¹¶è¡Œï¼Œ

é€šè¿‡è°ƒç”¨ Python è‡ªå¸¦çš„å¤šè¿›ç¨‹åº“ `Multiprocessing`,å¯ä»¥è½»æ¾çš„åœ¨æœ¬åœ°ç”µè„‘ä¸Šè¿›è¡Œå¤šæ ¸å¹¶è¡Œè®¡ç®—



# multiprocessing

è¿™ä¸ªæ¨¡å—ä¸»è¦æœ‰ä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š

## multiprocess.Process

### æ¥å£

multiprocess.Process([group [, target [, name [, args [, kwargs]]]]])ï¼Œç”±è¯¥ç±»å®ä¾‹åŒ–å¾—åˆ°çš„å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªå­è¿›ç¨‹ä¸­çš„ä»»åŠ¡ï¼ˆå°šæœªå¯åŠ¨ï¼‰

#### å‚æ•°ï¼š

- groupå‚æ•°æœªä½¿ç”¨ï¼Œå€¼å§‹ç»ˆä¸ºNone
- targetè¡¨ç¤ºè°ƒç”¨å¯¹è±¡ï¼Œå³å­è¿›ç¨‹è¦æ‰§è¡Œçš„ä»»åŠ¡
- argsè¡¨ç¤ºè°ƒç”¨å¯¹è±¡çš„ä½ç½®å‚æ•°å…ƒç»„ï¼Œargs=(1,2,'egon',)
- kwargsè¡¨ç¤ºè°ƒç”¨å¯¹è±¡çš„å­—å…¸ï¼Œkwargs={'name':'egon','age':18}
- nameä¸ºå­è¿›ç¨‹çš„åç§°

æ³¨æ„ï¼š

1. éœ€è¦ä½¿ç”¨å…³é”®å­—çš„æ–¹å¼æ¥æŒ‡å®šå‚æ•°
2. argsæŒ‡å®šçš„ä¸ºä¼ ç»™targetå‡½æ•°çš„ä½ç½®å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªå…ƒç»„å½¢å¼ï¼Œå¿…é¡»æœ‰é€—å·

### æ–¹æ³•

- p.start()ï¼šå¯åŠ¨è¿›ç¨‹ï¼Œå¹¶è°ƒç”¨è¯¥å­è¿›ç¨‹ä¸­çš„p.run()
- p.run()ï¼šè¿›ç¨‹å¯åŠ¨æ—¶è¿è¡Œçš„æ–¹æ³•ï¼Œæ­£æ˜¯å®ƒå»è°ƒç”¨targetæŒ‡å®šçš„å‡½æ•°ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ç±»çš„ç±»ä¸­ä¸€å®šè¦å®ç°è¯¥æ–¹æ³•
- p.terminate()ï¼šå¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹pï¼Œä¸ä¼šè¿›è¡Œä»»ä½•æ¸…ç†æ“ä½œï¼Œå¦‚æœpåˆ›å»ºäº†å­è¿›ç¨‹ï¼Œè¯¥å­è¿›ç¨‹å°±æˆäº†åƒµå°¸è¿›ç¨‹ï¼Œä½¿ç”¨è¯¥æ–¹æ³•éœ€è¦ç‰¹åˆ«å°å¿ƒè¿™ç§æƒ…å†µã€‚å¦‚æœpè¿˜ä¿å­˜äº†ä¸€ä¸ªé”é‚£ä¹ˆä¹Ÿå°†ä¸ä¼šè¢«é‡Šæ”¾ï¼Œè¿›è€Œå¯¼è‡´æ­»é”
- p.is_alive()ï¼šå¦‚æœpä»ç„¶è¿è¡Œï¼Œè¿”å›True
- p.join([timeout])ï¼šä¸»çº¿ç¨‹ç­‰å¾…pç»ˆæ­¢ï¼ˆå¼ºè°ƒï¼šæ˜¯ä¸»çº¿ç¨‹å¤„äºç­‰çš„çŠ¶æ€ï¼Œè€Œpæ˜¯å¤„äºè¿è¡Œçš„çŠ¶æ€ï¼‰ã€‚timeoutæ˜¯å¯é€‰çš„è¶…æ—¶æ—¶é—´ï¼Œéœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œp.joinåªèƒ½joinä½startå¼€å¯çš„è¿›ç¨‹ï¼Œè€Œä¸èƒ½joinä½runå¼€å¯çš„è¿›ç¨‹



## multiprocessing.Pool()

å½“è¢«æ“ä½œå¯¹è±¡æ•°ç›®ä¸å¤§æ—¶ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨multiprocessingä¸­çš„ProcessåŠ¨æ€æˆç”Ÿå¤šä¸ªè¿›ç¨‹ï¼Œåå‡ ä¸ªè¿˜å¥½ï¼Œä½†å¦‚æœæ˜¯ä¸Šç™¾ä¸ªï¼Œä¸Šåƒä¸ªç›®æ ‡ï¼Œæ‰‹åŠ¨çš„å»é™åˆ¶è¿›ç¨‹æ•°é‡å´åˆå¤ªè¿‡ç¹çï¼Œæ­¤æ—¶å¯ä»¥å‘æŒ¥è¿›ç¨‹æ± çš„åŠŸæ•ˆã€‚

Poolå¯ä»¥æä¾›æŒ‡å®šæ•°é‡çš„è¿›ç¨‹ä¾›ç”¨æˆ·è°ƒç”¨ï¼Œå½“æœ‰æ–°çš„è¯·æ±‚æäº¤åˆ°poolä¸­æ—¶ï¼Œå¦‚æœæ± è¿˜æ²¡æœ‰æ»¡ï¼Œé‚£ä¹ˆå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ç”¨æ¥æ‰§è¡Œè¯¥è¯·æ±‚ï¼›ä½†å¦‚æœæ± ä¸­çš„è¿›ç¨‹æ•°å·²ç»è¾¾åˆ°è§„å®šæœ€å¤§å€¼ï¼Œé‚£ä¹ˆè¯¥è¯·æ±‚å°±ä¼šç­‰å¾…ï¼Œç›´åˆ°æ± ä¸­æœ‰è¿›ç¨‹ç»“æŸï¼Œæ‰ä¼šåˆ›å»ºæ–°çš„è¿›ç¨‹æ¥å®ƒã€‚

### æ¥å£

multiprocessing.pool.Pool(processes=None, initializer=None, initargs=(), maxtasksperchild=None, context=None)

#### å‚æ•°ï¼š

- processes â€” è¿›ç¨‹æ± ä¸­è¿›ç¨‹æ•°é‡ï¼Œå¦‚æœä¸º Noneï¼Œåˆ™ä½¿ç”¨ os.cpu_count() è¿”å›çš„å€¼
- initializer â€” å¦‚æœè¯¥å‚æ•°ä¸ä¸º Noneï¼Œåˆ™æ‰€æœ‰è¿›ç¨‹æ± ä¸­çš„è¿›ç¨‹å¯åŠ¨æ—¶éƒ½ä¼šå…ˆæ‰§è¡Œ initializer(*initargs)
- maxtasksperchild â€” å¦‚æœè¯¥å‚æ•°ä¸ä¸º Noneï¼Œåˆ™è¿›ç¨‹åœ¨æ‰§è¡Œ maxtasksperchild æ¬¡ä»»åŠ¡åä¼šè¢«è‡ªåŠ¨é”€æ¯ã€é‡å¯
- context â€” ç”¨äºæŒ‡å®šè¿›ç¨‹æ± ä¸­è¿›ç¨‹è¿è¡Œçš„ä¸Šä¸‹æ–‡

### æ–¹æ³•ï¼š

- 1ã€apply()Â â€” è¯¥å‡½æ•°ç”¨äºä¼ é€’ä¸å®šå‚æ•°ï¼Œä¸»è¿›ç¨‹ä¼šè¢«é˜»å¡ç›´åˆ°å‡½æ•°æ‰§è¡Œç»“æŸï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼Œå¹¶ä¸”3.xä»¥åä¸å†å‡ºç°ï¼‰ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š
- apply(func, args=(), kwds={})

- 2ã€apply_asyncÂ â€” ä¸applyç”¨æ³•ä¸€è‡´ï¼Œä½†å®ƒæ˜¯éé˜»å¡çš„ä¸”æ”¯æŒç»“æœè¿”å›åè¿›è¡Œå›è°ƒï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

- apply_async(func[, args=()[, kwds={}[, callback=None]]])

- 3ã€map()Â â€” Poolç±»ä¸­çš„mapæ–¹æ³•ï¼Œä¸å†…ç½®çš„mapå‡½æ•°ç”¨æ³•åŸºæœ¬ä¸€è‡´ï¼Œå®ƒä¼šä½¿è¿›ç¨‹é˜»å¡ç›´åˆ°ç»“æœè¿”å›ï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

- map(func, iterable, chunksize=None)

- æ³¨æ„ï¼šè™½ç„¶ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªè¿­ä»£å™¨ï¼Œä½†åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¿…é¡»åœ¨æ•´ä¸ªé˜Ÿåˆ—éƒ½å°±ç»ªåï¼Œç¨‹åºæ‰ä¼šè¿è¡Œå­è¿›ç¨‹ã€‚

- 4ã€map_async()Â â€” ä¸mapç”¨æ³•ä¸€è‡´ï¼Œä½†æ˜¯å®ƒæ˜¯éé˜»å¡çš„ã€‚å…¶æœ‰å…³äº‹é¡¹è§apply_asyncï¼Œå‡½æ•°åŸå‹å¦‚ä¸‹ï¼š

- map_async(func, iterable, chunksize, callback)

- 5ã€close()Â â€” å…³é—­è¿›ç¨‹æ± ï¼ˆpoolï¼‰ï¼Œä½¿å…¶ä¸åœ¨æ¥å—æ–°çš„ä»»åŠ¡ã€‚

- 6ã€terminal()Â â€” ç»“æŸå·¥ä½œè¿›ç¨‹ï¼Œä¸åœ¨å¤„ç†æœªå¤„ç†çš„ä»»åŠ¡ã€‚

- 7ã€join()Â â€” ä¸»è¿›ç¨‹é˜»å¡ç­‰å¾…å­è¿›ç¨‹çš„é€€å‡ºï¼Œ joinæ–¹æ³•è¦åœ¨closeæˆ–terminateä¹‹åä½¿ç”¨ã€‚



# ä¾‹å­

æˆ‘ä¸»è¦ç”¨å¤šè¿›ç¨‹æ¥å¤„ç†æ•°æ®ã€ç”»å›¾ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŸºæœ¬çš„æ¨¡æ¿:

```python
# å¯¼å…¥æ¨¡å—
from pathlib import Path
import matplotlib.pyplot as plt
import numpy as np                      
import datetime
import multiprocessing as mp


# å®šä¹‰å¤„ç†å‡½æ•°
def single_worker(file_paths):
    # å¤„ç†æ–‡ä»¶å¯¹åº”çš„è·¯å¾„çš„æ•°æ®
    data = []
    for file_path in file_paths:
	
        with open(file_path, 'r') as f:
            data.append(f.read())

	# ç”»å›¾
    plt.plot(data)
    plt.show()
 
	# æ‰“å°è¿›ç¨‹
	print("finishing",Path(file_path).name) 
 

# å®šä¹‰é”™è¯¯å›è°ƒå‡½æ•°ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œèƒ½å°†é”™è¯¯åœ¨ä¸»è¿›ç¨‹ä¸­æ‰“å°å‡ºæ¥       
def error_callback(e):
    print('Error:', e)        

  # å°†æ€»æ•°æ®é›†è¿›è¡Œåˆ†å‰²ï¼Œåˆ†å‰²æˆå­æ•°æ®é›†
def task_split(path,batch_num):
  path = list(Path(path).glob("*"))
  # æ•°æ®é›†é•¿åº¦
  Len_path = len(pathlist)            
  param_dict ={}
  
  ## æ•°æ®åˆ†å‰²
  for i in range(batch_num):
    task = "task" + str(i)
    param_dict[task] = [(pathlist[i])]
    
  if Len_path >= batch_num:
    for i in range(batch_num,Len_path):
      task = "task" + str(int(i%batch_num))
      param_dict[task].append(pathlist[i])
  
  return param_dict

if __name__ == '__main__':
    start_t = datetime.datetime.now()
    # æŸ¥çœ‹cpuæ ¸æ•°
    num_cores = int(mp.cpu_count())
    print("æœ¬åœ°è®¡ç®—æœºæœ‰: " + str(num_cores) + " æ ¸å¿ƒ")
    # å¼€å¯æ ¸æ ¸æ•°ç›¸ç­‰çš„è¿›ç¨‹æ•°ç›®
    # pool = mp.Pool(num_cores)    
    
    ## éå†è¯»å–å½“å‰æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰å­æ–‡ä»¶å¤¹,å¹¶ä¸”è½¬åŒ–ä¸ºåˆ—è¡¨,æˆ‘è¿™é‡Œåªå¼€å¯8ä¸ªè¿›ç¨‹
    batch_num = 8
    param_dict = task_split(Path.cwd(),batch_num)
    
    # å¼€å¯å¤šè¿›ç¨‹å¤„ç†æ•°æ®
    pool = mp.Pool(batch_num)
    
    for name, param in param_dict.items():
      pool.apply_async(single_worker, args=(param,),error_callback=error_callback)
      
    # å…³é—­è¿›ç¨‹æ± 
    pool.close()
    # ç­‰å¾…ä»»åŠ¡å®Œæˆ
    pool.join()

    end_t = datetime.datetime.now()
    elapsed_sec = (end_t - start_t).total_seconds()
    print("å¤šè¿›ç¨‹è®¡ç®— å…±æ¶ˆè€—: " + "{:.2f}".format(elapsed_sec) + " ç§’")

```

æˆ‘å¤„ç†10ä¸ªç»“æœï¼Œå¦‚æœä½¿ç”¨å•è¿›ç¨‹éœ€è¦20å·¦å³ï¼Œå¼€å¯8ä¸ªè¿›ç¨‹ï¼Œå¹³å‡æ€»æ—¶é—´èƒ½å¤Ÿå‡å°‘åˆ°2sï¼Œå¤šè¿›ç¨‹æ•ˆæœéå¸¸æ˜æ˜¾ã€‚



ğŸŒŸæ³¨æ„ï¼š

å¿…é¡»æŠŠä¸»è¿›ç¨‹å†™åœ¨ã€Œç¨‹åºçš„å…¥å£ã€æ‰èƒ½æ­£å¸¸è¿è¡Œï¼š

```python
if __name__ =='__main__':
    ....
```

è¿™ä¹ˆåšï¼Œèƒ½å¤Ÿé¿å…é‡å¤æ‰§è¡Œä¸»è¿›ç¨‹



# å‚è€ƒé“¾æ¥ï¼š

[https://zhuanlan.zhihu.com/p/208996070](https://zhuanlan.zhihu.com/p/208996070)

[https://zhuanlan.zhihu.com/p/103135242](https://zhuanlan.zhihu.com/p/103135242)

[https://www.cnblogs.com/SkyOceanchen/p/11537587.html](https://www.cnblogs.com/SkyOceanchen/p/11537587.html)

https://zhuanlan.zhihu.com/p/340965963

